%% ========================================================================
% 散射效率计算程序
% 功能：使用Mie散射理论计算不同波长和粒子半径下的散射效率、吸收效率等参数
% ========================================================================

clc
clear
close all

%% ========================================================================
% 第一部分：定义计算参数
% ========================================================================

% 定义波长范围（单位：米）
% 波长范围：0.25 到 2.5 微米，步长 0.01 微米
lamda = (0.25:0.01:2.5)' * 10^-6;
lamda_um = lamda * 10^6;  % 转换为微米单位，便于显示

% 物理常数
c = 299792458;  % 光速 (m/s)
w = 2*pi*c./lamda;  % 角频率 (rad/s)

%% ========================================================================
% 第二部分：设置介质的光学常数
% ========================================================================

% 介质折射率和消光系数
% 这里设置为常数：折射率 n=1.5，消光系数 k=0（无吸收介质）
% 可以根据需要修改为其他材料的光学常数函数
n_medium = ones(length(lamda), 1) * 1.5;
k_medium = zeros(length(lamda), 1);

% 绘制介质光学常数
figure
plot(lamda_um, n_medium, 'k', lamda_um, k_medium, '-');
xlabel('波长 (\mum)');
ylabel('光学常数');
title('介质光学常数');
legend('折射率 n', '消光系数 k', 'Location', 'best');
grid on;

%% ========================================================================
% 第三部分：设置粒子的光学常数
% ========================================================================

% 粒子折射率和消光系数
% 这里设置为常数：TiO2, 可以根据需要修改为其他材料的光学常数函数
n_particle = TiO2_n(lamda);
k_particle = TiO2_k(lamda);

% 计算介电常数（实部和虚部）
eps1 = n_particle.^2 - k_particle.^2;  % 介电常数实部
eps2 = 2 .* n_particle .* k_particle;  % 介电常数虚部

% 绘制粒子光学常数
figure
plot(lamda_um, n_particle, 'k', lamda_um, k_particle, '-');
xlabel('波长 (\mum)');
ylabel('光学常数');
title('颜料光学常数');
legend('折射率 n', '消光系数 k', 'Location', 'best');
grid on;

% 绘制介电常数
figure
plot(lamda_um, eps1, 'k', lamda_um, eps2, '-');
xlabel('波长 (\mum)');
ylabel('介电常数');
title('颜料介电常数');
legend('实部 \epsilon_1', '虚部 \epsilon_2', 'Location', 'best');
grid on;

%% ========================================================================
% 第四部分：定义粒子半径范围
% ========================================================================

% 粒子半径范围（单位：米）
% 从 500nm 到 8000nm，步长 100nm（直径从 1000nm 到 16000nm）
r_particle  = (1000:200:16000) / 2 * 1e-9;

%% ========================================================================
% 第五部分：初始化结果矩阵
% ========================================================================

% 预分配内存以提高计算效率
Qscat = zeros(length(lamda), length(r_particle));      % 散射效率
Qback_scat = zeros(length(lamda), length(r_particle)); % 后向散射效率
Qabs = zeros(length(lamda), length(r_particle));        % 吸收效率
Cscat = zeros(length(lamda), length(r_particle));     % 散射截面
Cabs = zeros(length(lamda), length(r_particle));       % 吸收截面

%% ========================================================================
% 第六部分：Mie散射计算主循环
% ========================================================================

% 对每个粒子半径进行循环
for k = 1:length(r_particle)
    % 对每个波长进行循环
    for i = 1:length(lamda)
        % 获取当前波长下的介质折射率
        n_medium_sc = n_medium(i);
        
        % 计算尺寸参数 x = 2*pi*n_medium*r/lambda
        % 这是Mie理论中的关键无量纲参数
        x_1 = 2*pi*n_medium_sc*r_particle(k)/lamda(i);
        
        % 计算相对折射率 m = (n_particle + i*k_particle) / n_medium
        m1 = (n_particle(i) + 1i*k_particle(i)) / n_medium_sc;
        
        % 调用Mie函数计算散射参数
        % Mie函数返回：[qext, qsca, qabs, qb, asy, qratio]
        % 其中：qext=消光效率, qsca=散射效率, qabs=吸收效率, 
        %       qb=后向散射效率, asy=不对称参数, qratio=后向散射比
        mie_result = Mie(m1, x_1);
        
        % 提取计算结果
        Qscat(i, k) = mie_result(2);        % 散射效率
        Qback_scat(i, k) = mie_result(4);   % 后向散射效率
        Qabs(i, k) = mie_result(3);         % 吸收效率
        
        % 计算散射和吸收截面（单位：m^2）
        % 截面 = 几何截面 × 效率因子
        Cscat(i, k) = pi * r_particle(k)^2 * Qscat(i, k);
        Cabs(i, k) = pi * r_particle(k)^2 * Qabs(i, k);
    end
end

%% ========================================================================
% 程序结束
% 计算结果存储在以下变量中：
% - Qscat: 散射效率矩阵 [波长 × 半径]
% - Qback_scat: 后向散射效率矩阵 [波长 × 半径]
% - Qabs: 吸收效率矩阵 [波长 × 半径]
% - Cscat: 散射截面矩阵 [波长 × 半径]
% - Cabs: 吸收截面矩阵 [波长 × 半径]
% ========================================================================

